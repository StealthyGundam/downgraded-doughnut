<link rel="stylesheet" href="css/neon.css">
<link rel="stylesheet" href="css/luck.css">


        
    <h1>Luck Skill Test</h1>
    <section>
        <h3>Roll a YAHTZEE to pass this skill test!</h3>
        <div class="container">
            <div class="dice-grid">
                <div class="scene">
                    <div class="dice"></div>
                </div>
                <div class="scene">
                    <div class="dice"></div>
                </div>
            </div>

            <div class="dice-grid second">
                <div class="scene">
                    <div class="dice"></div>
                </div>
                <div class="scene">
                    <div class="dice"></div>
                </div>
                <div class="scene">
                    <div class="dice"></div>
                </div>
            </div>
            <br>
            <button id="rollBtn" onclick="rollDice()">Roll</button>

            <div id="result"></div>
            <div id="counter"></div>
            <button id="nextBtn" style="display:none;" onclick="goToNext()">Continue</button>

        </div>
    </section>
<script>
(() => {
    const KEY = "page.luck.completed";
    const rollBtn = document.getElementById("rollBtn");
    const nextBtn = document.getElementById("nextBtn");
    const resultEl = document.getElementById("result");
    const counterEl = document.getElementById("counter");

    // SPA Auto-Skip
    if (localStorage.getItem(KEY) === "true") {
        rollBtn?.remove();
        nextBtn.style.display = "inline-block";
    }

    // Player Data
    const selectedPerk = localStorage.getItem("selectedPerk");
    const skillValues = JSON.parse(localStorage.getItem("skillValues")) || {};
    const luck = skillValues.Luck || 1;
    const normalizedPerk = selectedPerk?.replace(/[\u2010-\u2015]/g, "-");
    const hasClover = normalizedPerk === "Seven-Leaf Clover";

    // Luck Scaling
    const luckBonus = Math.max(0, luck - 3) * 0.01;

    // Roll Counter
    let rollCount = parseInt(localStorage.getItem("YahtzeeRolls"), 10) || 0;
    counterEl.textContent = `Rolls: ${rollCount}`;

    // Dice Faces
    const faces = {
        1: [4],
        2: [0, 8],
        3: [0, 4, 8],
        4: [0, 2, 6, 8],
        5: [0, 2, 4, 6, 8],
        6: [0, 2, 3, 5, 6, 8]
    };

    const diceElements = document.querySelectorAll('.dice');

    // Build Dice
    diceElements.forEach(dice => {
        for (let i = 1; i <= 6; i++) {
            const face = document.createElement('div');
            face.className = `face face${i}`;
            for (let j = 0; j < 9; j++) {
                const cell = document.createElement('div');
                if (faces[i].includes(j)) cell.className = 'pip';
                face.appendChild(cell);
            }
            dice.appendChild(face);
        }
    });

    // Face Rotations
    const faceRotation = {
        1: [0, 0],
        2: [0, -90],
        3: [0, 180],
        4: [0, 90],
        5: [-90, 0],
        6: [90, 0]
    };

    // Weighted Die Roll
    function rollDie() {
        if (!hasClover) return Math.floor(Math.random() * 6) + 1;

        const weights = [
            { value: 1, weight: 10 },
            { value: 2, weight: 10 },
            { value: 3, weight: 10 },
            { value: 4, weight: 10 },
            { value: 5, weight: 30 },
            { value: 6, weight: 99 }
        ];

        const total = weights.reduce((s, w) => s + w.weight, 0);
        let roll = Math.random() * total;

        for (const w of weights) {
            if ((roll -= w.weight) <= 0) return w.value;
        }
        return 6;
    }

    // Roll Dice + Yahtzee Detection
    function rollDice() {
        const values = [];
        rollBtn.disabled = true;
        resultEl.textContent = "";

        rollCount++;
        localStorage.setItem("YahtzeeRolls", rollCount);
        counterEl.textContent = `Rolls: ${rollCount}`;

        diceElements.forEach((dice, index) => {
            let value = rollDie();
            if (index > 0 && Math.random() < luckBonus) value = values[0];
            values.push(value);

            const [fx, fy] = faceRotation[value];
            const spinsX = (Math.floor(Math.random() * 3) + 3) * 360;
            const spinsY = (Math.floor(Math.random() * 3) + 3) * 360;
            const spinsZ = (Math.floor(Math.random() * 2) + 1) * 360;

            dice.style.transition = 'none';
            dice.style.transform = 'rotateX(0deg) rotateY(0deg) rotateZ(0deg)';
            dice.offsetHeight;

            dice.style.transition = 'transform 2s linear';
            dice.style.transform = `rotateX(${spinsX + fx}deg) rotateY(${spinsY + fy}deg) rotateZ(${spinsZ}deg)`;
        });

        setTimeout(() => {
            const isYahtzee = values.every(v => v === values[0]);
            resultEl.textContent = isYahtzee ? "YAHTZEE!" : "Try Again!";

            if (isYahtzee) {
                localStorage.setItem(KEY, "true");
                rollBtn.remove();
                nextBtn.style.display = "inline-block";

                // SPA next page
                nextBtn.addEventListener("click", () => {
                    document.dispatchEvent(new CustomEvent("spa-next-page"));
                });
            } else {
                rollBtn.disabled = false;
            }
        }, 2000);
    }

    // Attach event
    rollBtn.addEventListener("click", rollDice);

})();
            </script>






