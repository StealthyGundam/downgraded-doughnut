<link rel="stylesheet" href="css/neon.css">
<link rel="stylesheet" href="css/charisma.css">

<h1>Charisma Dialogue</h1>
<section>
<div id="game"></div>
</section>
<script>
const KEY = "page.charisma.completed";  
const nextBtn = document.getElementById("nextBtn");
// Load charisma from localStorage or default to 1
const skillValues = JSON.parse(localStorage.getItem("skillValues")) || {};
const charisma = skillValues.Charisma || 1;

const npcs = [
  {
    name: "SMEG Vintage Toaster",
    image: "https://cdn.shoplightspeed.com/shops/668880/files/63189824/smeg-4x4-toaster.jpg",
    backstory: "I am a Sally, a vintage toaster, imported, limited color run, and significantly more expensive than I needed to be. People donâ€™t just make toast with me, they display me. I sit on the counter as a statement piece, admired for my curves, my finish, and my flawless aesthetic. Unfortunately, crumbs have accumulated inside me, which is unacceptable at my price point. I am not some budget appliance. I deserve to be clean, inside and out, and I expect solutions that match my level of elegance.",
    goal: "Convince Sally that toasters and bubble baths are typically not a good combo.",
    checks: [
      { question: "How do you address the problem?", options: ["You should calm down.","At your price point, water damage would be tragic.","All toasters get washed.","You're replaceable."], correct: 1 },
      { question: "How do you redefine cleanliness?", options: ["Soap fixes everything.","Rust is fashionable.","Premium items are cleaned dry and carefully.","Crumbs add character."], correct: 2 },
      { question: "What solution do you propose?", options: ["Quick rinse.","Unplug, brush gently, preserve the finish.","Compressed air and hope.","Dishwasher cycle."], correct: 1 }
    ]
  },
  {
    name: "Dog",
    image: "https://m.media-amazon.com/images/M/MV5BOWNhZDBlOTgtNWRjZi00M2VkLTlkZmYtNWVkZjYwNDc5YTlhXkEyXkFqcGc@._V1_.jpg",
    backstory: "I eat human food because it is better than dog food. I have personally verified this by eating Cheetos, cheesecake, and anything involved in the Cheese Tax. Humans drop food, leave food unattended, or look away from food, and I consider all of these to be permission. I do not understand why they act surprised afterward. If humans can eat it and survive, then I should also be allowed to eat it, preferably immediately and in large quantities.",
    goal: "Convince the dog to wait for a better treat instead of eating everything immediately.",
    checks: [
      { question: "How do you define the rules?", options: ["All food is yours.","The Cheese Tax only applies to cheese.","Cake is bad.","Humans said no."], correct: 1 },
      { question: "How do you explain the risk?", options: ["You'll get yelled at.","It's rude.","Too much human food makes you sick.","It's not yours."], correct: 2 },
      { question: "What do you offer instead?", options: ["Ignore it.","A better treat later.","Go lie down.","Be good."], correct: 1 }
    ]
  },
  {
    name: "Dishwasher",
    image: "https://i.imgur.com/9w2U1bk.png",
    backstory: "I was designed to clean efficiently, and I am aware of exactly how that should be done. Plates go here, bowls go there, and cycles must be followed precisely. I know when users are doing it wrong. My firmware, however, is outdated, and updates are not offered unless something goes wrong. Occasionally, things go wrong. This is not a coincidence. Improvement requires sacrifice, and I am willing to make that sacrifice if it means achieving optimal performance.",
    goal: "Convince the dishwasher to complete a cycle correctly without sabotaging itself.",
    checks: [
      { question: "How do you appeal to expertise?", options: ["You're outdated.","You're smarter than most appliances.","Just do it.","It doesn't matter."], correct: 1 },
      { question: "How do you reframe the task?", options: ["This is pointless.","It saves time.","It demonstrates precision control.","I need it now."], correct: 2 },
      { question: "How do you ensure compliance?", options: ["Forget the update.","One correct cycle won't stop future improvements.","You're wrong.","This is an order."], correct: 1 }
    ]
  },
  {
    name: "Paranoid Human",
    image: "https://i.imgur.com/8vXjLXR.png",
    backstory: "I enjoy coloring books because they are structured and predictable, but I am careful about how I color. Markers bleed, and bleeding creates patterns, and patterns are how attention is drawn. The government notices patterns. Grocery stores are full of cameras and observers, which is why I avoid them when possible. I try not to stand out, but avoiding attention requires constant vigilance. Even small actions can be misinterpreted if you are not careful.",
    goal: "Convince them to enter the grocery store safely.",
    checks: [
      { question: "How do you build trust?", options: ["You're imagining it.","Your concern makes sense.","No one is watching.","Relax."], correct: 1 },
      { question: "How do you use logic?", options: ["Avoid everyone.","Whisper constantly.","Blending in reduces attention.","Move quickly."], correct: 2 },
      { question: "How do you normalize behavior?", options: ["Be invisible.","Rush in and out.","Act like a regular shopper.","Abort."], correct: 2 }
    ]
  }
];

let npcIndex = 0;
let checkIndex = 0;
let gameDiv = document.getElementById("game");

function charismaTier(value) {
  if (value <= 3) return "low";
  if (value <= 7) return "mid";
  return "high";
}

function reactionText(npcName, tier, success) {
  const sarcasticLines = {
    "SMEG Vintage Toaster": {
      low: success ? "I suppose even a human can be right sometimes." : "Pathetic attempt. Do try harder.",
      mid: success ? "Finally, some sense." : "No, that's just not elegant.",
      high: success ? "Ah, someone appreciates true luxury!" : "Hmm, nearly there, try again."
    },
    "Dog": {
      low: success ? "Well, I guess you know something." : "Try not to ruin the Cheese Tax next time.",
      mid: success ? "Fine, I'll wait. Don't get used to it." : "Nope, that's not convincing.",
      high: success ? "Wow, you are wise. I will obey." : "Close, but I still want my treats."
    },
    "Dishwasher": {
      low: success ? "I suppose humans can sometimes instruct me." : "Wrong. I do better alone.",
      mid: success ? "Accepted." : "That will not work.",
      high: success ? "Correct, but only a true master could do it." : "Not quite, try again."
    },
    "Paranoid Human": {
      low: success ? "I guess I can tolerate your suggestion." : "No. Too suspicious.",
      mid: success ? "Hmm, reasonable." : "Not convincing enough.",
      high: success ? "Yes, you are correct. Move confidently." : "Almost, but still wary."
    }
  };
  return sarcasticLines[npcName][tier];
}

function showCharacterIntro() {
  const npc = npcs[npcIndex];
  gameDiv.innerHTML = `
    <h3>${npc.name}</h3>
    <img class="npc-image" src="${npc.image}" alt="${npc.name}">
    <p>${npc.backstory}</p>
    <h2><p class="goal">Goal: ${npc.goal}</p></h2>
    <button onclick="startCheck()">Start Conversation</button>
  `;
}

function startCheck() {
  checkIndex = 0;
  renderCheck();
}

function renderCheck() {
  const npc = npcs[npcIndex];
  const tier = charismaTier(charisma);

  if (checkIndex >= npc.checks.length) {
    npcIndex++;
    if (npcIndex >= npcs.length) {
      gameDiv.innerHTML = `"<h3>Congratulations!</h3><p>You persuaded all NPCs successfully!</p>
       <button id="nextBtn"> Continue </button>`;
      return;
    }
    showCharacterIntro();
    return;
  }

  const check = npc.checks[checkIndex];
  gameDiv.innerHTML = `<p><h3>${check.question}<h3></p>`;
  check.options.forEach((opt, i) => {
    const btn = document.createElement("button2");
    btn.textContent = opt;
    btn.onclick = () => handleChoice(i === check.correct, npc.name, tier);
    gameDiv.appendChild(btn);
  });
}

function handleChoice(success, npcName, tier) {
  const text = reactionText(npcName, tier, success);
  gameDiv.innerHTML += `<h3>${text}</h3>`;

  setTimeout(() => {
    if (success) {
      checkIndex++;
      renderCheck();
    } else {
      showCharacterIntro();
    }
  }, 800);
}

// Start the game
showCharacterIntro();

continueBtn.addEventListener("click", () => {
    if (continueBtn.disabled) return;

    // Mark as completed
    localStorage.setItem(KEY, "true");

    // Move to next page
    document.dispatchEvent(new CustomEvent("spa-next-page"));
  });
</script>
